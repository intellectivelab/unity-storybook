import {Meta} from '@storybook/addon-docs/blocks';

<Meta title="Examples/Lookup Field/README"/>

# Lookup Field Usage Example

This page provides various examples of using and customizing the Lookup Field component.

<br/>

## Example - Custom selection handler

This example shows how to a use a context of the selected entity to be able to fill out other form fields when needed.
In this example we are going to compose address related values of selected Assign To User field and assign it to Assignee Address.

### Steps

Implement a function that takes a context of the selected entity from the lookup field and populate other field
by composing some values from the context and dispatching it within updateFieldValue redux form action.

```jsx
const onLookupSelectHandler = R.curry ((formId, fieldId, dispatch, value) => {
    const nameMapper = value => {
        const nameExtractor = value => value && value.name || value && value.value || value;
        return value && Array.isArray(value) ? value.map(v => nameExtractor(v)) : nameExtractor(value);
    };

    const address = R.compose(
        R.join(','),
        R.map(nameMapper),
        R.values,
        R.pick(['country', 'state', 'city', 'zipCode'])
    )(value || {});

    dispatch(forms.updateFieldValue(formId, fieldId, address));
});
```

Create an extension (HOC) for the Lookup Field component to handle its onSelect event by onLookupSelectHandler.

```jsx
const withSelectionHandler = R.curry((formId, fieldId, WrappedField, props) => {
	const dispatch = useDispatch();

	return <WrappedField {...props} onSelect={onLookupSelectHandler(formId, fieldId, dispatch)}/>;
});
```

Create an extension (HOC) for the ViewForm component to extend the lookup field with withSelectionHandler HOC.

```jsx
const withCustomFormFieldMapper = R.curry((WrappedForm, props) => {
	const {formId} = props;
	const linkedFieldId = "assignee_address";

	const {FieldComponent = FormField, ...otherProps} = props;

	const withCustomFieldMapper = R.curry((WrappedField, props) => {
		const {lookupId} = props;

		const UsersLookupField = useMemo(() => R.compose(withSelectionHandler(formId, linkedFieldId))(LookupField), []);

		const domainFormFieldMapper = R.cond([
		    [() => "usersLookup" === lookupId,  R.always(UsersLookupField)],
			[R.T, useDefaultFormFieldMapper]
		]);

		return <WrappedField {...props} fieldMapper={domainFormFieldMapper} />
	});


	const _FieldComponent = withCustomFieldMapper(FieldComponent);

	return <WrappedForm FieldComponent={_FieldComponent} {...otherProps} />
});
```

Extend the default view form component with the custom form field mapper.

```jsx
const CreateCaseViewForm = R.compose(withResourceDataLoader, withCustomFormFieldMapper)(DefaultViewForm);
```

Create a page with the custom form field mapper.
```jsx
const DomainCreateCasePropertiesPage = {
    label: 'Fill in details',
    icon: CreateIcon,
    view: CreateCaseViewForm
};
```

Extend the default create case action with the custom form field mapper.

```jsx
const DomainCreateCaseAction = (props) => withActionView({
    ...props,
    title: <ResourceCreateViewTitle resourceName="Case"/>,
    ViewForm: ResourceCreateWizard,
    pages: [DomainCreateCasePropertiesPage, CreateCasePreviewPage, CreateCaseAttachmentsPage],
    submitLabel: 'Create Case'
}, () => null);


const DomainActionMapper = R.curry((settings = {}, action) => {
    // Add custom actions creation logic here. For example,

    const isCreateAction = R.propEq('type', 'create');
    const isCaseResource = R.propEq('resourceName', "cases");
    const isCreateCaseAction = R.allPass([isCreateAction, isCaseResource]);

    return R.cond([
        [isCreateCaseAction, R.always(DomainCreateCaseAction(settings))],
    ])(action);
});
```
Implement the domain action factory.

```jsx
function DomainActionFactory(defaultSettings = {}) {
    DefaultActionFactory.call(this, defaultSettings);

    this.createAction = R.curry((action, props) => {
        const {settings = {}, ...otherProps} = props;

        const {view: viewSettings = {}} = settings;

        const ActionComponent = DomainActionMapper({...defaultSettings, ...viewSettings}, action) || DefaultActionMapper({...defaultSettings, ...viewSettings}, action);

        return <ActionComponent {...otherProps} {...action} action={action}/>;
    });
}
```
